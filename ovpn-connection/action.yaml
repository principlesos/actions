# action.yaml
name: 'OVPN Connection'
description: 'Installs openvpn, configures and connects to supplied ovpn network'
inputs:
  ovpn-config:
    description: 'Config file for ovpn connection'
    required: true
  vpn-creds:
    description: 'Username/Password for vpn auth'
    required: true
  vpn-ip:
    description: 'VPN IP'
    required: true
runs:
  using: "composite"
  steps:
    - run: |
        sudo apt-get update
        sudo apt-get --assume-yes --no-install-recommends install openvpn
      shell: bash
    - run: |
        echo "${{ inputs.ovpn-config }}" > config.ovpn
        echo "${{ inputs.vpn-creds }}" > secret.txt
        sudo openvpn --config "config.ovpn" --compat-mode 2.3.0 --log "vpn.log" --daemon
        timeout=60
        current_ip=""
        while [[ "$(current_ip=$(curl -4 ifconfig.me))" != "${{ inputs.vpn-ip }}" && $timeout -gt 0 ]]; do
          sleep 2
          timeout=$((timeout - 2))
        done
        if [[ $timeout -le 0 ]]; then
          echo "Failed to connect to VPN. Current IP: $current_ip"
          exit 1
        fi
      shell: bash
